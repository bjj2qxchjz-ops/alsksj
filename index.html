<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS 桌面模拟 (IndexedDB版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Serif+SC:wght@400;700&family=Courier+Prime&display=swap" rel="stylesheet">
    
    <style id="custom-bubble-style">
        /* 用户自定义的气泡CSS会在这里生效 */
    </style>
    <style id="custom-fonts-style"></style>
    <style>
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', 'sans-serif';
        }
        .app-label, .editable-text {
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        .mobile-screen-container {
            background-color: #f3f4f6;
            width: 100%;
            max-width: 390px;
            height: 844px;
            border: 12px solid #111;
            border-radius: 48px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            overflow: hidden;
            position: relative;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard syntax */
        }
        .status-bar-left {
            position: absolute;
            top: 14px;
            left: 36px;
            color: #1f2937;
            font-weight: 600;
            font-size: 14px;
        }
        .status-bar-right {
            position: absolute;
            top: 14px;
            right: 36px;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #1f2937;
        }
        #desktop-container.font-white .editable-text,
        #desktop-container.font-white .status-bar-left,
        #desktop-container.font-white .status-bar-right {
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }
        #desktop-container.font-black .editable-text,
        #desktop-container.font-black .status-bar-left,
        #desktop-container.font-black .status-bar-right {
            color: #1f2937;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .settings-item, .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .settings-item:hover, .list-item:hover {
            background-color: #f0f0f0;
        }
        .wechat-friend-item {
            background-color: white;
            padding: 10px 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .wechat-friend-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }
        .icon-upload-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .icon-upload-item:last-child {
            border-bottom: none;
        }
        .icon-upload-label {
            background-color: #e5e7eb;
            color: #374151;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .icon-upload-label:hover {
            background-color: #d1d5db;
        }
        .chat-message-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 90%;
            -webkit-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        .chat-message-wrapper.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .chat-message-wrapper.received {
            align-self: flex-start;
        }
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }
        .chat-bubble {
            padding: 10px 16px;
            border-radius: 12px;
            word-wrap: break-word;
            position: relative;
            max-width: 100%;
        }
        .chat-bubble-sent {
            background-color: #a9e87a;
        }
        .chat-bubble-received {
            background-color: #ffffff;
        }
        .wechat-tab.active {
            color: #07c160;
            font-weight: 600;
        }
        .voice-bubble {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 0;
        }
        .chat-bubble-sent .voice-icon { transform: scaleX(-1); }
        .voice-translation {
            margin-top: 6px;
            padding: 6px 8px;
            background-color: rgba(0,0,0,0.05);
            border-radius: 8px;
            font-size: 0.8rem;
            color: #333;
            border-top: 1px solid rgba(0,0,0,0.08);
        }
        .chat-image {
            max-width: 150px;
            max-height: 200px;
            border-radius: 12px;
            cursor: pointer;
            display: block;
            background-color: #e5e7eb;
        }
        #chat-plus-menu {
            transition: opacity 0.2s, transform 0.2s;
        }
        .image-description {
            margin-top: 6px;
            font-size: 0.8rem;
            color: #555;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 4px 8px;
            border-radius: 8px;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            display: none;
        }
        @keyframes white-glow-fade {
            0% {
                box-shadow: 0 0 12px 4px rgba(255, 255, 255, 0.7);
            }
            100% {
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            }
        }
        .new-friend-glow {
            animation: white-glow-fade 1.5s ease-out;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .voice-bubble .voice-duration {
            font-size: 0.9rem;
            color: #333;
            margin: 0 8px;
        }
        .chat-message-wrapper.sent .voice-duration {
            order: -1;
        }
        .voice-wave {
            display: flex;
            align-items: center;
            gap: 1px;
            height: 16px;
        }
        .voice-wave span {
            display: block;
            background-color: #666;
            border-radius: 2px;
            width: 2px;
        }
        .chat-message-wrapper.sent .voice-wave span {
            background-color: #333;
        }
        .voice-wave .w-1 { height: 25%; }
        .voice-wave .w-2 { height: 60%; }
        .voice-wave .w-3 { height: 90%; }
        #chat-hold-to-talk-btn:active {
            background-color: #d1d5db;
        }
        #details-character-info .flex.items-center.space-x-4 {
            align-items: flex-start;
        }
        #details-character-text-block {
            flex-grow: 1;
            min-width: 0;
        }
    </style>
</head>
<body class="bg-gray-800 flex items-center justify-center min-h-screen">

    <!-- The HTML structure remains exactly the same as your provided file. -->
    <!-- I will only replace the <script> part at the end. -->
    <!-- ... (All your HTML elements from <div class="mobile-screen-container"> to the last modal) ... -->
    <div class="mobile-screen-container" id="mobileScreen">
        <div id="desktop-container" class="relative w-full h-full text-gray-800 flex flex-col">
            <div id="wallpaper-bg" class="absolute inset-0 bg-gray-300 bg-cover bg-center z-0" style="background-image: url('https://images.unsplash.com/photo-1619521448831-5682855239a2?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxfDB8MXxyYW5kb218MHx8bW91bnRhaW4sc3RhcnJ5LG5pZ2h0fHx8fHx8MTY5OTk0ODg1OQ&ixlib=rb-4.0.3&q=80&w=1080');"></div>

            <div class="relative z-10 flex flex-col h-full">
                <header class="w-full h-10 px-6 pt-1 flex-shrink-0">
                    <div class="status-bar-left">
                        <span class="flex items-center gap-1.5">
                            11:14
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
                            </svg>
                        </span>
                    </div>
                    <div class="status-bar-right">
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8A13 13 0 0 1 15 20M2 4A17 17 0 0 1 19 20"/>
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5 12.55a11 11 0 0 1 14.08 0"/>
                            <path d="M1.42 9a16 16 0 0 1 21.16 0"/>
                            <path d="M8.53 16.11a6 6 0 0 1 6.95 0"/>
                            <line x1="12" y1="20" x2="12.01" y2="20"/>
                        </svg>
                        <div class="flex items-center gap-0.5 text-xs font-medium">
                            40%
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="2" y="7" width="18" height="10" rx="2" ry="2"></rect>
                                <line x1="22" y1="11" x2="22" y2="13"></line>
                                <rect x="4" y="9" width="7" height="6" rx="1" ry="1" fill="currentColor"></rect>
                            </svg>
                        </div>
                    </div>
                </header>

                <main class="flex-grow w-full px-4 pt-4 pb-2 flex flex-col gap-5 overflow-y-auto">
                    
                    <div class="w-full h-auto rounded-3xl p-4 flex flex-col items-center relative overflow-hidden shadow-lg">
                        <input type="file" id="widget-bg-input" class="hidden" accept="image/*">
                        <input type="file" id="widget-profile-input" class="hidden" accept="image/*">
                        <img id="widget-bg-image" src="https://placehold.co/350x200/374151/ffffff?text=BG" alt="背景图片" class="absolute top-0 left-0 w-full h-full object-cover cursor-pointer">
                        <div class="absolute top-0 left-0 w-full h-full bg-gray-900 opacity-60 z-0"></div>
                        
                        <div class="w-full h-24"></div>
                        
                        <img id="widget-profile-image" src="https://placehold.co/100x100/4b5563/e5e7eb?text=Profile" alt="头像" class="w-24 h-24 rounded-full border-4 border-gray-800 relative -mt-12 z-10 shadow-md cursor-pointer">
                        
                        <span id="profileName" class="mt-3 font-bold text-white text-2xl z-10 editable-text">Leaf Drift</span>
                        <span id="profileHandle" class="mt-1 text-sm text-gray-300 z-10 editable-text">@leafdrift</span>
                        <span id="profileSignature" class="mt-2 text-sm text-gray-400 z-10 editable-text">这是一个自定义签名</span>
                        
                        <div class="mt-2 flex items-center gap-1.5 text-gray-400 text-sm z-10">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            <span id="profileLocation" class="editable-text">定位: 北京</span>
                        </div>
                    </div>
                    <div id="widgetLabel1" class="px-2 mt-2 text-xs text-gray-500 font-medium uppercase widget-label cursor-pointer editable-text">Colorful Widget</div>

                    <div class="grid grid-cols-4 gap-y-6 gap-x-4">
                        <div id="wechatApp" class="col-span-1 flex flex-col items-center cursor-pointer app-item" data-app-id="wechat" data-app-name="微信">
                            <div id="app-icon-wechat" class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center shadow-md app-icon-container overflow-hidden bg-cover bg-center">
                                <svg class="w-10 h-10 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            </div>
                            <span id="appLabelWechat" class="mt-1.5 text-xs text-white editable-text">微信</span>
                        </div>

                        <div id="settingsApp" class="col-span-1 flex flex-col items-center cursor-pointer app-item" data-app-id="settings" data-app-name="设置">
                            <div id="app-icon-settings" class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center shadow-md app-icon-container overflow-hidden bg-cover bg-center">
                                <svg class="w-10 h-10 text-gray-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                </svg>
                            </div>
                            <span id="appLabelSettings" class="mt-1.5 text-xs text-white editable-text">设置</span>
                        </div>
                        
                        <div id="sticky-note-widget" class="col-span-2 row-span-2 bg-white rounded-3xl p-3.5 flex flex-col shadow-lg relative overflow-hidden">
                            <div id="sticky-note-bg-layer" class="absolute inset-0 bg-cover bg-center z-0" style="display: none; filter: blur(4px); transform: scale(1.1);"></div>
                            <div class="relative z-10">
                                <div class="flex justify-between items-start">
                                    <span id="widget2Title" class="text-sm font-semibold text-gray-800 editable-text">标题</span>
                                    <span id="widget2Number" class="text-3xl font-bold text-gray-800 editable-text">23</span>
                                </div>
                                <div class="mt-2 flex flex-col divide-y divide-dashed divide-gray-300">
                                    <p id="widget2Line1" class="text-xs text-gray-600 pb-1.5 editable-text">第一行小字内容</p>
                                    <p id="widget2Line2" class="text-xs text-gray-600 py-1.5 editable-text">第二行小字内容</p>
                                    <p id="widget2Line3" class="text-xs text-gray-600 pt-1.5 editable-text">第三行小字内容</p>
                                </div>
                            </div>
                        </div>
                        <div id="worldBookApp" class="col-span-1 flex flex-col items-center cursor-pointer app-item" data-app-id="books" data-app-name="世界书">
                            <div id="app-icon-books" class="w-16 h-16 bg-orange-500 rounded-2xl flex items-center justify-center text-white shadow-md app-icon-container overflow-hidden bg-cover bg-center">
                                <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"></path></svg>
                            </div>
                            <span id="appLabelBooks" class="mt-1.5 text-xs text-white editable-text">世界书</span>
                        </div>
                        <div class="col-span-1 flex flex-col items-center app-item" data-app-id="music" data-app-name="音乐">
                            <div id="app-icon-music" class="w-16 h-16 bg-black rounded-2xl flex items-center justify-center text-white shadow-md app-icon-container overflow-hidden bg-cover bg-center">
                                <svg class="w-10 h-10" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 18H10a6 6 0 0 1-6-6V7a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v5"/><path d="M18 18h2a2 2 0 0 0 2-2v-1a2 2 0 0 0-2-2h-2v5z"/><path d="M18 13V9"/><path d="M20 6.34C19.2 6.13 18.1 6 17 6a6 6 0 0 0-6 6v1"/></svg>
                            </div>
                            <span id="appLabelMusic" class="mt-1.5 text-xs text-white editable-text">音乐</span>
                        </div>
                    </div> 
                    <div id="widgetLabel2" class="px-2 mt-2 text-xs text-gray-500 font-medium uppercase editable-text">Another Widget</div>
                </main>

                <footer class="w-full flex-shrink-0 px-3 pb-5">
                    <div class="w-full bg-gray-200/80 backdrop-blur-md rounded-3xl p-3 flex justify-around items-center shadow-lg">
                        <div id="dock-icon-phone" class="w-14 h-14 bg-green-500 rounded-2xl flex items-center justify-center app-icon-container overflow-hidden bg-cover bg-center" data-app-id="phone" data-app-name="电话"><svg class="w-8 h-8 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></div>
                        <div id="dock-icon-messages" class="w-14 h-14 bg-green-500 rounded-2xl flex items-center justify-center app-icon-container overflow-hidden bg-cover bg-center" data-app-id="messages" data-app-name="信息"><svg class="w-8 h-8 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path></svg></div>
                        <div id="dock-icon-browser" class="w-14 h-14 bg-blue-500 rounded-2xl flex items-center justify-center app-icon-container overflow-hidden bg-cover bg-center" data-app-id="browser" data-app-name="浏览器"><svg class="w-8 h-8 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg></div>
                        <div id="dock-icon-contacts" class="w-14 h-14 bg-gray-100 rounded-2xl flex items-center justify-center app-icon-container overflow-hidden bg-cover bg-center" data-app-id="contacts" data-app-name="通讯录"><svg class="w-10 h-10 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg></div>
                    </div>
                </footer>
            </div>
        </div>

        <div id="settings-page" class="absolute inset-0 bg-gray-100 flex-col z-20 hidden">
            <header class="w-full bg-gray-200/80 backdrop-blur-md p-4 flex items-center justify-center relative flex-shrink-0">
                <button class="absolute left-4 text-blue-600 back-button">&lt; 桌面</button>
                <h2 class="font-bold text-lg">设置</h2>
            </header>
            <main class="flex-grow p-4 space-y-4 overflow-y-auto">
                <div id="goToApiPage" class="settings-item rounded-t-lg"><span>API 连接</span><span class="text-gray-400">&gt;</span></div>
                <div id="goToThemePage" class="settings-item"><span>主题</span><span class="text-gray-400">&gt;</span></div>
                <div id="goToDataPage" class="settings-item rounded-b-lg"><span>数据</span><span class="text-gray-400">&gt;</span></div>
            </main>
        </div>

        <div id="api-page" class="absolute inset-0 bg-gray-100 flex-col z-30 hidden">
            <header class="w-full bg-gray-200/80 backdrop-blur-md p-4 flex items-center relative flex-shrink-0">
                <button class="absolute left-4 text-blue-600 back-button">&lt; 设置</button>
                <h2 class="font-bold text-lg mx-auto">API 连接</h2>
            </header>
            <main class="flex-grow p-4 space-y-4">
                <div class="bg-white p-4 rounded-lg space-y-4">
                    <div>
                        <label for="apiUrlInput" class="block text-sm font-medium text-gray-700">API 地址</label>
                        <input type="text" id="apiUrlInput" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="例如: https://api.example.com/v1">
                    </div>
                    <div>
                        <label for="apiKeyInput" class="block text-sm font-medium text-gray-700">API 密钥 (Key)</label>
                        <input type="text" id="apiKeyInput" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="请输入你的 API Key">
                    </div>
                    <button id="connectApiButton" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">连接并拉取模型</button>
                </div>
                 <div id="model-selection-container" class="bg-white p-4 rounded-lg space-y-4 mt-4 hidden">
                    <div>
                        <label for="model-selector" class="block text-sm font-medium text-gray-700">选择模型</label>
                        <select id="model-selector" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            </select>
                    </div>
                    <button id="save-api-model" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">保存模型设置</button>
                </div>
            </main>
        </div>

        <div id="theme-page" class="absolute inset-0 bg-gray-100 flex-col z-30 hidden">
            <header class="w-full bg-gray-200/80 backdrop-blur-md p-4 flex items-center relative flex-shrink-0">
                <button class="absolute left-4 text-blue-600 back-button">&lt; 设置</button>
                <h2 class="font-bold text-lg mx-auto">主题</h2>
            </header>
            <main class="flex-grow p-4 space-y-6 overflow-y-auto">
                <div class="bg-white p-4 rounded-lg space-y-3">
                    <h3 class="font-semibold">桌面壁纸</h3>
                    <input type="text" id="wallpaperUrl" class="w-full p-2 border rounded-md" placeholder="输入图片 URL">
                    <div class="flex gap-2">
                        <input type="file" id="wallpaperFile" accept="image/*" class="hidden">
                        <label for="wallpaperFile" class="flex-1 text-center bg-gray-200 py-2 px-4 rounded-lg cursor-pointer hover:bg-gray-300">上传文件</label>
                        <button id="applyWallpaper" class="flex-1 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">应用 URL</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg space-y-3">
                    <h3 class="font-semibold">桌面顶部插件背景</h3>
                    <p class="text-xs text-gray-500">为最上方的大插件更换背景图。</p>
                    <input type="file" id="mainWidgetBgInput" class="hidden" accept="image/*">
                    <label for="mainWidgetBgInput" class="block w-full text-center bg-gray-200 py-2 px-4 rounded-lg cursor-pointer hover:bg-gray-300">上传背景图</label>
                </div>

                <div class="bg-white p-4 rounded-lg space-y-3">
                    <h3 class="font-semibold">桌面便利贴背景</h3>
                    <p class="text-xs text-gray-500">为三行字便利贴设置一个模糊背景图。</p>
                    <input type="file" id="stickyNoteBgInput" class="hidden" accept="image/*">
                    <label for="stickyNoteBgInput" class="block w-full text-center bg-gray-200 py-2 px-4 rounded-lg cursor-pointer hover:bg-gray-300">上传背景图</label>
                </div>
                
                <div class="bg-white p-4 rounded-lg space-y-3">
                    <h3 class="font-semibold">桌面字体颜色</h3>
                    <div class="flex gap-2">
                        <button id="fontColorWhite" class="flex-1 bg-gray-200 py-2 px-4 rounded-lg hover:bg-gray-300">白色</button>
                        <button id="fontColorBlack" class="flex-1 bg-gray-200 py-2 px-4 rounded-lg hover:bg-gray-300">黑色</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg space-y-3">
                    <h3 class="font-semibold">全局字体</h3>
                    <select id="fontSelector" class="w-full p-2 border rounded-md">
                        <option value="'Inter', sans-serif">默认字体 (Inter)</option>
                        <option value="'Noto Serif SC', serif">思源宋体</option>
                        <option value="'Courier Prime', monospace">等宽字体</option>
                        <option value="Arial, sans-serif">Arial</option>
                    </select>
                    <div class="mt-2 space-y-2">
                        <input type="text" id="fontUrl" class="w-full p-2 border rounded-md" placeholder="输入字体链接 (TTF, WOFF2)">
                        <button id="applyFontUrl" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">应用链接字体</button>
                    </div>
                    <input type="file" id="fontFile" accept=".ttf,.otf,.woff,.woff2" class="hidden">
                    <label for="fontFile" class="block w-full text-center bg-gray-200 py-2 px-4 rounded-lg cursor-pointer hover:bg-gray-300 mt-2">上传本地字体文件</label>
                </div>

                <div class="bg-white p-4 rounded-lg space-y-3">
                    <h3 class="font-semibold">图标形状</h3>
                    <div class="flex gap-2">
                        <button class="change-icon-shape flex-1 bg-gray-200 py-2 px-4 rounded-lg hover:bg-gray-300" data-shape="rounded-2xl">圆角矩形</button>
                        <button class="change-icon-shape flex-1 bg-gray-200 py-2 px-4 rounded-lg hover:bg-gray-300" data-shape="rounded-full">圆形</button>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-lg space-y-2">
                    <h3 class="font-semibold">自定义应用图标</h3>
                    <div id="icon-upload-list">
                        </div>
                </div>

            </main>
        </div>

        <div id="data-page" class="absolute inset-0 bg-gray-100 flex-col z-30 hidden">
            <header class="w-full bg-gray-200/80 backdrop-blur-md p-4 flex items-center relative flex-shrink-0">
                <button class="absolute left-4 text-blue-600 back-button">&lt; 设置</button>
                <h2 class="font-bold text-lg mx-auto">数据</h2>
            </header>
            <main class="flex-grow p-4 space-y-4">
                 <div class="bg-white p-4 rounded-lg space-y-3">
                    <h3 class="font-semibold">导出数据</h3>
                    <p class="text-sm text-gray-600">将当前所有设置（包括文本、图片、字体、聊天记录等）打包成一个文件，以便在其他设备或浏览器上恢复。</p>
                    <button id="exportData" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">导出全部数据</button>
                 </div>
                 <div class="bg-white p-4 rounded-lg space-y-3">
                    <h3 class="font-semibold">导入数据</h3>
                    <p class="text-sm text-gray-600">从导出的 .json 文件中恢复所有设置。此操作将覆盖当前所有数据。</p>
                    <input type="file" id="importDataInput" accept=".json" class="hidden">
                    <label for="importDataInput" class="block w-full text-center bg-gray-200 py-2 px-4 rounded-lg cursor-pointer hover:bg-gray-300">选择文件并导入</label>
                 </div>
            </main>
        </div>

        <div id="worldbook-list-page" class="absolute inset-0 bg-gray-100 flex-col z-20 hidden">
            <header class="w-full bg-gray-200/80 backdrop-blur-md p-4 flex items-center justify-between relative flex-shrink-0">
                <button class="text-blue-600 back-button">&lt; 桌面</button>
                <h2 class="font-bold text-lg">世界书</h2>
                <button id="createNewWorldBook" class="text-blue-600 text-2xl font-light">+</button>
            </header>
            <main id="worldbook-list-container" class="flex-grow p-4 space-y-px overflow-y-auto">
                </main>
        </div>

        <div id="worldbook-editor-page" class="absolute inset-0 bg-gray-100 flex-col z-30 hidden">
            <header class="w-full bg-gray-200/80 backdrop-blur-md p-4 flex items-center justify-between relative flex-shrink-0">
                <button class="text-blue-600 back-button">&lt; 世界书</button>
                <h2 class="font-bold text-lg">编辑</h2>
                <button id="saveWorldBook" class="text-blue-600 font-semibold">保存</button>
            </header>
            <main class="flex-grow p-4 space-y-4 flex flex-col">
                <input type="hidden" id="worldbook-id">
                <input type="text" id="worldbook-title" class="w-full p-3 border rounded-lg text-lg" placeholder="世界书标题">
                <textarea id="worldbook-content" class="w-full flex-grow p-3 border rounded-lg resize-none" placeholder="输入世界书内容..."></textarea>
            </main>
        </div>
        
        <div id="wechat-page" class="absolute inset-0 bg-gray-100 flex flex-col z-20 hidden">
            <div class="flex-grow overflow-y-auto">
                <div id="wechat-chat-tab-content" class="wechat-tab-content">
                    <header class="sticky top-0 w-full bg-gray-200/80 backdrop-blur-md p-4 flex items-center relative flex-shrink-0">
                        <button class="absolute left-4 text-blue-600 back-button">&lt; 桌面</button>
                        <h2 class="font-bold text-lg w-full text-center">微信</h2>
                        <div class="absolute right-4">
                            <button id="wechat-add-btn" class="text-gray-800 text-2xl font-light">+</button>
                            <div id="wechat-add-menu" class="absolute right-0 mt-2 w-40 bg-white rounded-md shadow-lg hidden z-10">
                                <a id="wechat-add-friend" href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">添加好友</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">创建群聊</a>
                            </div>
                        </div>
                    </header>
                    <main id="wechat-chat-list" class="flex-grow p-4 overflow-y-auto">
                        </main>
                </div>
                <div id="wechat-moments-tab-content" class="wechat-tab-content hidden">
                     <header class="sticky top-0 w-full bg-gray-200/80 backdrop-blur-md p-4 flex items-center justify-center relative flex-shrink-0">
                        <h2 class="font-bold text-lg mx-auto">朋友圈</h2>
                    </header>
                    <div class="p-8 text-center text-gray-500">朋友圈功能待开发...</div>
                </div>
                <div id="wechat-me-tab-content" class="wechat-tab-content hidden p-4 space-y-4">
                    <header class="sticky top-0 w-full bg-gray-200/80 backdrop-blur-md p-4 flex items-center justify-center relative flex-shrink-0 -mx-4 -mt-4 mb-4">
                        <h2 class="font-bold text-lg mx-auto">我的人设</h2>
                    </header>
                    <div id="my-personas-list" class="space-y-3">
                        </div>
                    <div class="mt-4">
                        <button id="add-new-persona-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700">添加新的人设</button>
                    </div>
                </div>
            </div>
            <footer class="w-full bg-gray-200 flex-shrink-0 border-t border-gray-300 flex justify-around items-center py-2">
                <button class="wechat-tab active" data-tab="wechat-chat-tab-content">聊天</button>
                <button class="wechat-tab" data-tab="wechat-moments-tab-content">朋友圈</button>
                <button class="wechat-tab" data-tab="wechat-me-tab-content">我</button>
            </footer>
        </div>
        
        <div id="me-settings-page" class="absolute inset-0 bg-gray-100 flex-col z-30 hidden">
            <header class="w-full bg-gray-200/80 backdrop-blur-md p-4 flex items-center justify-between relative flex-shrink-0">
                <button class="text-blue-600 back-button">&lt; 我</button>
                <h2 class="font-bold text-lg">编辑人设</h2>
                <button id="save-me-settings-btn" class="text-blue-600 font-semibold">保存</button>
            </header>
            <main class="flex-grow p-4 space-y-4 overflow-y-auto">
                 <input type="hidden" id="me-settings-persona-id">
                 <div class="flex flex-col items-center space-y-4 bg-white p-6 rounded-lg">
                    <img id="me-settings-avatar-preview" src="https://placehold.co/100x100/e2e8f0/94a3b8?text=Avatar" class="w-24 h-24 rounded-full object-cover shadow-md">
                    <input type="file" id="me-settings-avatar-input" class="hidden" accept="image/*">
                    <label for="me-settings-avatar-input" class="w-full text-center bg-gray-200 py-2 px-4 rounded-lg cursor-pointer hover:bg-gray-300">上传头像</label>
                </div>
                <div class="bg-white p-4 rounded-lg space-y-3">
                     <label for="me-settings-name" class="font-semibold text-gray-700">名字</label>
                     <input id="me-settings-name" type="text" class="w-full p-2 border rounded-md" placeholder="输入你的名字">
                </div>
                <div class="bg-white p-4 rounded-lg space-y-3">
                     <h3 class="font-semibold">我的设定</h3>
                     <textarea id="me-settings-persona" class="w-full p-2 border rounded-md h-32" placeholder="为自己添加一些设定..."></textarea>
                </div>
            </main>
        </div>

        <div id="chat-interface-page" class="absolute inset-0 bg-gray-100 flex flex-col z-40 hidden">
            <header class="w-full bg-gray-200/80 backdrop-blur-md p-4 flex items-center justify-between relative flex-shrink-0">
                <button class="absolute left-4 text-blue-600 back-button">&lt; 微信</button>
                <h2 id="chat-header-name" class="font-bold text-lg w-full text-center">聊天对象</h2>
                 <div class="absolute right-4 flex items-center">
                    <button id="go-to-chat-details-btn">
                        <svg class="w-8 h-8 text-gray-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle>
                        </svg>
                    </button>
                </div>
            </header>
            <main id="chat-messages-container" class="flex-grow p-4 space-y-4 overflow-y-auto flex flex-col">
                </main>
            <footer class="p-2 bg-gray-200 border-t flex items-end gap-2 relative">
                <button id="chat-mode-toggle-btn" class="flex-shrink-0 w-9 h-9 flex items-center justify-center self-center">
                    <svg id="chat-voice-icon" class="w-6 h-6 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93V17h-2v-2.07A8.002 8.002 0 012 8V6h2v2a6 6 0 1012 0V6h2v2a8.002 8.002 0 01-5 7.48V14.93z" clip-rule="evenodd"></path></svg>
                    <svg id="chat-keyboard-icon" class="w-6 h-6 text-gray-600 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 5H2a2 2 0 00-2 2v6a2 2 0 002 2h16a2 2 0 002-2V7a2 2 0 00-2-2zM2 3a2 2 0 00-2 2v1h1v-1a1 1 0 011-1h16a1 1 0 011 1v1h1V5a2 2 0 00-2-2H2zm0 14h16a1 1 0 011 1v1h-1v-1a2 2 0 00-2-2H4a2 2 0 00-2 2v1H1v-1a1 1 0 011-1zm3 2h2v-2H5v2zm4 0h2v-2H9v2zm4 0h2v-2h-2v2z" clip-rule="evenodd"></path></svg>
                </button>
                
                <textarea id="chat-input" class="flex-grow p-2 border bg-white rounded-lg resize-none" placeholder="输入消息..." rows="1" style="max-height: 120px;"></textarea>
                <button id="chat-hold-to-talk-btn" class="flex-grow p-2 border bg-white rounded-lg text-gray-700 font-semibold hidden">按住 说话</button>
                
                <button id="chat-ai-reply-btn" class="flex-shrink-0 w-9 h-9 flex items-center justify-center self-center text-2xl text-black hover:scale-110 transition-transform" title="点击让AI回复">♡</button>
                
                <button id="chat-plus-btn" class="flex-shrink-0 w-9 h-9 flex items-center justify-center self-center">
                    <svg class="w-7 h-7 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
                <button id="chat-send-btn" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hidden self-center">发送</button>
                
                <div id="chat-plus-menu" class="absolute bottom-full left-0 right-0 p-4 bg-gray-100 border-t grid grid-cols-4 gap-4 hidden opacity-0 -translate-y-4">
                     <div id="chat-upload-image" class="flex flex-col items-center cursor-pointer">
                        <div class="w-14 h-14 bg-white rounded-xl flex items-center justify-center"><svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div>
                        <span class="text-xs mt-1">相册</span>
                        <input type="file" id="chat-image-input" class="hidden" accept="image/*">
                    </div>
                     <div id="chat-take-photo" class="flex flex-col items-center cursor-pointer">
                        <div class="w-14 h-14 bg-white rounded-xl flex items-center justify-center"><svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div>
                        <span class="text-xs mt-1">拍照</span>
                    </div>
                </div>
            </footer>
        </div>
        
        <div id="chat-details-page" class="absolute inset-0 bg-gray-100 flex-col z-50 hidden">
            <header class="w-full bg-gray-200/80 backdrop-blur-md p-4 flex items-center justify-between relative flex-shrink-0">
                <button class="text-blue-600 back-button">&lt; 聊天</button>
                <h2 class="font-bold text-lg">聊天信息</h2>
                <div class="w-16"></div>
            </header>
            <main class="flex-grow p-4 space-y-4 overflow-y-auto">
                <div class="bg-white p-4 rounded-lg">
                    <div id="details-character-text-block" class="flex justify-between items-start cursor-pointer min-w-0">
                        <div>
                            <h3 id="details-character-name" class="text-xl font-semibold truncate">名字</h3>
                            <p id="details-character-persona" class="text-sm text-gray-500 mt-1 line-clamp-2">对方人设...</p>
                        </div>
                        <span class="text-gray-400 flex-shrink-0">&gt;</span>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t">
                        <div class="grid grid-cols-4 sm:grid-cols-5 gap-2">
                            <div class="flex flex-col items-center text-center">
                                <div id="details-avatar-block" class="relative cursor-pointer">
                                    <img id="details-character-avatar" src="" class="w-14 h-14 rounded-lg object-cover shadow-md">
                                    <input type="file" id="details-character-avatar-input" class="hidden" accept="image/*">
                                </div>
                                <span id="details-avatar-label-name" class="text-xs text-gray-700 mt-1.5 truncate w-14"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg space-y-3">
                    <label for="details-persona-selector" class="font-semibold text-gray-800">我的人设</label>
                    <select id="details-persona-selector" class="w-full p-2 border rounded-md bg-white text-gray-700">
                        </select>
                </div>
                
                <div class="bg-white p-4 rounded-lg space-y-3">
                    <label for="details-worldbook-selector" class="font-semibold text-gray-800">绑定世界书</label>
                    <select id="details-worldbook-selector" class="w-full p-2 border rounded-md bg-white text-gray-700">
                         </select>
                </div>
                
                <div class="bg-white p-4 rounded-lg space-y-3">
                    <h3 class="font-semibold">聊天外观</h3>
                    <button id="open-bubble-css-editor" class="settings-item !p-0">
                        <span>自定义气泡</span>
                        <span class="text-gray-400">&gt;</span>
                    </button>
                </div>

                <div class="mt-4">
                    <button id="clear-chat-history-btn" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">清空聊天记录</button>
                </div>
                </main>
        </div>


    </div>

    <div id="textModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-xs overflow-hidden transform transition-all">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">修改文本</h3>
                <input type="text" id="appInput" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="输入新内容">
            </div>
            <div class="flex border-t border-gray-200">
                <button id="cancelButton" class="flex-1 py-3 text-center text-red-600 font-medium hover:bg-gray-50 transition duration-150">取消</button>
                <button id="confirmButton" class="flex-1 py-3 text-center text-blue-600 font-medium border-l border-gray-200 hover:bg-gray-50 transition duration-150">确认</button>
            </div>
        </div>
    </div>
    
    <div id="add-friend-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-11/11 max-w-xs overflow-hidden transform transition-all">
            <div class="p-6 space-y-4">
                <h3 class="text-lg font-semibold text-gray-800 text-center">添加好友</h3>
                <div class="flex flex-col items-center">
                    <img id="add-friend-avatar-preview" src="https://placehold.co/100x100/e2e8f0/94a3b8?text=Avatar" class="w-20 h-20 rounded-full mb-2 object-cover">
                    <input type="file" id="add-friend-avatar" class="hidden" accept="image/*">
                    <label for="add-friend-avatar" class="text-sm text-blue-600 cursor-pointer">上传头像</label>
                </div>
                <input type="text" id="add-friend-name" class="w-full p-2 border rounded-lg" placeholder="名字">
                <textarea id="add-friend-persona" class="w-full p-2 border rounded-lg h-24" placeholder="人物设定"></textarea>
                <select id="add-friend-worldbook" class="w-full p-2 border rounded-lg bg-white">
                    <option value="">不绑定世界书</option>
                    </select>
            </div>
            <div class="flex border-t border-gray-200">
                <button id="add-friend-cancel" class="flex-1 py-3 text-center text-red-600 font-medium hover:bg-gray-50">取消</button>
                <button id="add-friend-confirm" class="flex-1 py-3 text-center text-blue-600 font-medium border-l hover:bg-gray-50">创建</button>
            </div>
        </div>
    </div>
    
    <div id="imageDescriptionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-[280px] overflow-hidden transform transition-all">
            <div class="p-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">描述画面内容</h3>
                <input type="hidden" id="imageRawData" value=""> 
                <textarea id="imageDescInput" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 h-20" placeholder="例如：一只猫在阳光下打盹"></textarea>
            </div>
            <div class="flex border-t border-gray-200">
                <button id="cancelImageDesc" class="flex-1 py-3 text-center text-red-600 font-medium hover:bg-gray-50 transition duration-150">取消</button>
                <button id="confirmImageDesc" class="flex-1 py-3 text-center text-blue-600 font-medium border-l border-gray-200 hover:bg-gray-50 transition duration-150">发送</button>
            </div>
        </div>
    </div>

    <div id="voiceInputModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[60]">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-xs overflow-hidden">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">模拟语音输入</h3>
                <textarea id="voiceInputText" class="w-full p-2 border rounded-lg h-24 resize-none" placeholder="输入要转为语音的消息"></textarea>
            </div>
            <div class="flex border-t">
                <button id="cancelVoiceInput" class="flex-1 py-3 text-center text-red-600 font-medium hover:bg-gray-50">取消</button>
                <button id="confirmVoiceInput" class="flex-1 py-3 text-center text-blue-600 font-medium border-l hover:bg-gray-50">发送</button>
            </div>
        </div>
    </div>
    
    <div id="customBubbleModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center z-[60]">
        <div class="bg-gray-100 rounded-xl shadow-2xl w-11/12 max-w-md overflow-hidden flex flex-col" style="height: 70%;">
            <header class="p-4 bg-white border-b flex items-center justify-between">
                <div class="w-12"></div>
                <h3 class="text-lg font-semibold text-gray-800 text-center">自定义气泡 CSS</h3>
                <button id="cancelBubbleCss" class="text-blue-600">关闭</button>
            </header>
            <main class="flex-grow p-4 overflow-y-auto flex flex-col">
                <p class="text-xs text-gray-600 mb-2 flex-shrink-0">可用选择器: <code class="bg-gray-200 p-1 rounded text-red-600">.chat-bubble-sent</code> (我), <code class="bg-gray-200 p-1 rounded text-red-600">.chat-bubble-received</code> (对方)</p>
                <textarea id="bubbleCssInput" class="w-full flex-grow p-2 border rounded-lg font-mono text-sm resize-none" placeholder=".chat-bubble-sent {&#10;  background-color: #your-color;&#10;  border-radius: 10px;&#10;}"></textarea>
            </main>
            <footer class="p-3 bg-white border-t space-y-2">
                 <button id="copyBubbleCss" class="w-full text-center bg-gray-200 py-2 px-4 rounded-lg text-sm hover:bg-gray-300">一键复制气泡CSS模板</button>
                <button id="saveBubbleCss" class="w-full py-2 text-center text-white bg-blue-600 rounded-lg hover:bg-blue-700">保存该气泡</button>
            </footer>
        </div>
    </div>

    <div id="personaEditModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[60]">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-sm overflow-hidden transform transition-all">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">编辑角色信息</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">名字</label>
                        <input type="text" id="personaEditName" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">人设</label>
                        <textarea id="personaEditInput" class="w-full p-2 border rounded-lg h-32 resize-none" placeholder="输入角色设定"></textarea>
                    </div>
                </div>
            </div>
            <div class="flex border-t border-gray-200">
                <button id="cancelPersonaEdit" class="flex-1 py-3 text-center text-red-600 font-medium hover:bg-gray-50">取消</button>
                <button id="confirmPersonaEdit" class="flex-1 py-3 text-center text-blue-600 font-medium border-l hover:bg-gray-50">保存</button>
            </div>
        </div>
    </div>

    <div id="toast-notification" class="fixed bottom-20 left-1/2 -translate-x-1/2 bg-gray-900/80 backdrop-blur-sm text-white text-sm py-2 px-4 rounded-full shadow-lg opacity-0 transition-all duration-300 z-[100]">
        通知内容
    </div>


<script>

document.addEventListener('DOMContentLoaded', async function() {
    
    // --- IndexedDB 辅助工具 ---
    const idb = {
        db: null,
        dbName: 'iosDesktopDB',
        dbVersion: 1,
        
        // 初始化数据库
        async init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(this.dbName, this.dbVersion);

                request.onerror = (event) => {
                    console.error("IndexedDB error:", event.target.error);
                    reject("IndexedDB error");
                };

                request.onupgradeneeded = (event) => {
                    this.db = event.target.result;
                    console.log("Upgrading database...");
                    
                    // 1. 配置表 (键值对)
                    if (!this.db.objectStoreNames.contains('configs')) {
                        this.db.createObjectStore('configs', { keyPath: 'key' });
                    }
                    // 2. 世界书
                    if (!this.db.objectStoreNames.contains('worldBooks')) {
                        this.db.createObjectStore('worldBooks', { keyPath: 'id' });
                    }
                    // 3. 用户人设
                    if (!this.db.objectStoreNames.contains('userPersonas')) {
                        this.db.createObjectStore('userPersonas', { keyPath: 'id' });
                    }
                    // 4. 聊天角色
                    if (!this.db.objectStoreNames.contains('chatCharacters')) {
                        this.db.createObjectStore('chatCharacters', { keyPath: 'id' });
                    }
                    // 5. 聊天消息
                    if (!this.db.objectStoreNames.contains('chatMessages')) {
                        const store = this.db.createObjectStore('chatMessages', { keyPath: 'id', autoIncrement: true });
                        // 为聊天消息创建索引，以便按好友ID快速查找
                        store.createIndex('by_characterId', 'characterId', { unique: false });
                    }
                    // 6. 自定义字体
                    if (!this.db.objectStoreNames.contains('customFonts')) {
                        this.db.createObjectStore('customFonts', { keyPath: 'name' });
                    }
                };

                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    console.log("Database opened successfully.");
                    resolve(this.db);
                };
            });
        },
        
        async getStore(storeName, mode = 'readonly') {
            if (!this.db) await this.init();
            return this.db.transaction(storeName, mode).objectStore(storeName);
        },

        // 获取单个项目
        async get(storeName, key) {
            const store = await this.getStore(storeName);
            return new Promise((resolve, reject) => {
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        
        // 获取一个表中的所有项目
        async getAll(storeName) {
            const store = await this.getStore(storeName);
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        
        // 存入或更新单个项目
        async put(storeName, item) {
            const store = await this.getStore(storeName, 'readwrite');
            return new Promise((resolve, reject) => {
                const request = store.put(item);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },

        // 批量存入或更新
        async bulkPut(storeName, items) {
            const tx = this.db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            for (const item of items) {
                store.put(item);
            }
            return new Promise((resolve, reject) => {
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        },

        // 删除单个项目
        async delete(storeName, key) {
            const store = await this.getStore(storeName, 'readwrite');
            return new Promise((resolve, reject) => {
                const request = store.delete(key);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        },

        // 清空一个表
        async clear(storeName) {
            const store = await this.getStore(storeName, 'readwrite');
            return new Promise((resolve, reject) => {
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        },

        // 特殊方法：根据好友ID获取聊天记录
        async getMessagesForChat(characterId) {
            const store = await this.getStore('chatMessages');
            const index = store.index('by_characterId');
            return new Promise((resolve, reject) => {
                const request = index.getAll(characterId);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        
        // 特殊方法：根据好友ID删除聊天记录
        async deleteMessagesForChat(characterId) {
            const store = await this.getStore('chatMessages', 'readwrite');
            const index = store.index('by_characterId');
            const request = index.openCursor(IDBKeyRange.only(characterId));
            return new Promise((resolve, reject) => {
                request.onsuccess = () => {
                    const cursor = request.result;
                    if (cursor) {
                        cursor.delete();
                        cursor.continue();
                    } else {
                        resolve();
                    }
                };
                request.onerror = () => reject(request.error);
            });
        }
    };
    
    // 初始化数据库连接
    await idb.init();

    // --- 全局提示弹窗 (Toast) 功能 ---
    const toastElement = document.getElementById('toast-notification');
    let toastTimeout;

    function showToast(message) {
        clearTimeout(toastTimeout);
        toastElement.textContent = message;
        toastElement.classList.remove('opacity-0', 'translate-y-4');
        toastElement.classList.add('opacity-100', 'translate-y-0');

        toastTimeout = setTimeout(() => {
            toastElement.classList.remove('opacity-100', 'translate-y-0');
            toastElement.classList.add('opacity-0', 'translate-y-4');
        }, 2000);
    }

    // --- 文本编辑弹窗逻辑 ---
    const modal = document.getElementById('textModal');
    const appInput = document.getElementById('appInput');
    const cancelButton = document.getElementById('cancelButton');
    const confirmButton = document.getElementById('confirmButton');
    let currentWidgetLabel = null;

    document.querySelectorAll('.editable-text').forEach(label => {
        label.addEventListener('click', function(e) {
            e.stopPropagation(); 
            currentWidgetLabel = this;
            appInput.value = this.textContent.trim(); 
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            appInput.focus();
        });
    });

    cancelButton.addEventListener('click', () => {
        modal.classList.remove('flex');
        modal.classList.add('hidden');
    });

    confirmButton.addEventListener('click', async () => {
        if (currentWidgetLabel) {
            currentWidgetLabel.textContent = appInput.value;
            
            if (currentWidgetLabel.id) {
                const allTexts = (await idb.get('configs', 'editableTexts'))?.value || {};
                allTexts[currentWidgetLabel.id] = appInput.value;
                await idb.put('configs', { key: 'editableTexts', value: allTexts });
            }
        }
        modal.classList.remove('flex');
        modal.classList.add('hidden');
    });

    appInput.addEventListener('keydown', e => e.key === 'Enter' && confirmButton.click());

    // --- 页面导航逻辑 ---
    const desktopContainer = document.getElementById('desktop-container');
    const allPages = document.querySelectorAll('.mobile-screen-container > div:not(#desktop-container)');
    let pageHistory = [desktopContainer];

    function showPage(pageElement) {
        const currentPage = pageHistory[pageHistory.length - 1];
        if (currentPage) {
            currentPage.style.display = 'none';
            currentPage.classList.add('hidden');
            currentPage.classList.remove('flex');
        }
        
        pageElement.style.display = 'flex';
        pageElement.classList.remove('hidden');
        pageHistory.push(pageElement);
    }

    async function goBack() {
        if (pageHistory.length > 1) {
            const currentPage = pageHistory.pop();
            currentPage.style.display = 'none';
            currentPage.classList.add('hidden');
            currentPage.classList.remove('flex');

            const previousPage = pageHistory[pageHistory.length - 1];
            previousPage.style.display = 'flex';
            previousPage.classList.remove('hidden');
            
            if (previousPage.id === 'wechat-page') {
                await renderChatList();
                await renderMyPersonas(); 
            }
             if (previousPage.id === 'worldbook-list-page') {
                await renderWorldBookList();
            }
        }
    }
    
    document.querySelectorAll('.back-button').forEach(button => button.addEventListener('click', goBack));
    
    document.getElementById('settingsApp').addEventListener('click', () => showPage(document.getElementById('settings-page')));
    document.getElementById('worldBookApp').addEventListener('click', async () => {
        await renderWorldBookList();
        showPage(document.getElementById('worldbook-list-page'));
    });
    document.getElementById('wechatApp').addEventListener('click', async () => {
        await renderChatList();
        await renderMyPersonas();
        showPage(document.getElementById('wechat-page'));
    });

    document.getElementById('goToApiPage').addEventListener('click', async () => {
        await loadApiModelSettings();
        showPage(document.getElementById('api-page'));
    });
    document.getElementById('goToThemePage').addEventListener('click', async () => {
        await populateIconUploads();
        showPage(document.getElementById('theme-page'));
    });
    document.getElementById('goToDataPage').addEventListener('click', () => showPage(document.getElementById('data-page')));
    
    // --- 数据导入导出功能 ---
    const storeNamesToExport = ['configs', 'worldBooks', 'userPersonas', 'chatCharacters', 'chatMessages', 'customFonts'];

    document.getElementById('exportData').addEventListener('click', async () => {
        const dataToExport = {};
        for (const storeName of storeNamesToExport) {
            dataToExport[storeName] = await idb.getAll(storeName);
        }

        const dataStr = JSON.stringify(dataToExport, null, 2);
        const dataBlob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(dataBlob);
        
        const a = document.createElement('a');
        a.href = url;
        const date = new Date();
        const dateString = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}`;
        a.download = `ios_desktop_backup_idb_${dateString}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('数据已导出！');
    });

    document.getElementById('importDataInput').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                let importedCount = 0;

                for (const storeName of storeNamesToExport) {
                    if (importedData[storeName] && Array.isArray(importedData[storeName])) {
                        await idb.clear(storeName);
                        await idb.bulkPut(storeName, importedData[storeName]);
                        importedCount++;
                    }
                }
                
                if (importedCount > 0) {
                    alert('数据导入成功！页面即将刷新以应用所有更改。');
                    location.reload();
                } else {
                    showToast('未在文件中找到有效数据。');
                }

            } catch (error) {
                console.error("导入数据失败:", error);
                alert('导入失败！请确保文件是正确的备份文件。');
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsText(file);
    });

    // --- 主题页面逻辑 (壁纸) ---
    async function applyAndSaveWallpaper(imageUrl) {
        if (!imageUrl) return;
        document.getElementById('wallpaper-bg').style.backgroundImage = `url('${imageUrl}')`;
        await idb.put('configs', { key: 'desktopWallpaperUrl', value: imageUrl });
        showToast('壁纸已应用');
    }

    document.getElementById('applyWallpaper').addEventListener('click', () => {
        const url = document.getElementById('wallpaperUrl').value;
        applyAndSaveWallpaper(url);
    });

    document.getElementById('wallpaperFile').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => applyAndSaveWallpaper(e.target.result);
            reader.readAsDataURL(file);
        }
    });

    async function loadDesktopWallpaper() {
        const savedUrl = (await idb.get('configs', 'desktopWallpaperUrl'))?.value;
        if (savedUrl) {
            document.getElementById('wallpaper-bg').style.backgroundImage = `url('${savedUrl}')`;
        }
    }

    // --- 主题页面逻辑 (字体) ---
    const fontSelector = document.getElementById('fontSelector');
    const fontUrlInput = document.getElementById('fontUrl');
    const fontFileInput = document.getElementById('fontFile');
    const applyFontUrlBtn = document.getElementById('applyFontUrl');
    const customFontsStyle = document.getElementById('custom-fonts-style');

    async function applyAndSaveFont(fontFamily) {
        document.getElementById('mobileScreen').style.fontFamily = fontFamily;
        await idb.put('configs', { key: 'globalFont', value: fontFamily });
    }
    
    fontSelector.addEventListener('change', function() {
        applyAndSaveFont(this.value);
    });

    async function addNewFont(fontUrl, isFile = false) {
        if (!fontUrl) return;

        let fontName = prompt("请为这个新字体命名:", isFile ? fontFileInput.files[0].name.split('.')[0] : "自定义网络字体");
        if (!fontName) {
            showToast("已取消添加字体");
            return;
        }
        fontName = fontName.trim();

        if (await idb.get('customFonts', fontName)) {
            showToast("错误：该字体名称已存在！");
            return;
        }

        const newFont = { name: fontName, url: fontUrl };
        await idb.put('customFonts', newFont);
        
        await loadCustomFonts();
        showToast(`字体 "${fontName}" 已添加`);
    }

    applyFontUrlBtn.addEventListener('click', () => {
        addNewFont(fontUrlInput.value.trim());
        fontUrlInput.value = '';
    });

    fontFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (re) => addNewFont(re.target.result, true);
            reader.readAsDataURL(file);
        }
    });

    async function loadCustomFonts() {
        const customFonts = await idb.getAll('customFonts') || [];
        let fontFaceRules = '';
        
        Array.from(fontSelector.options).forEach(option => {
            if (option.dataset.custom) option.remove();
        });

        customFonts.forEach(font => {
            fontFaceRules += `
                @font-face {
                    font-family: '${font.name}';
                    src: url('${font.url}');
                }
            `;
            const option = document.createElement('option');
            const fontValue = `'${font.name}', sans-serif`;
            option.value = fontValue;
            option.textContent = `${font.name} (自定义)`;
            option.dataset.custom = true;
            fontSelector.appendChild(option);
        });

        customFontsStyle.innerHTML = fontFaceRules;
    }
    
    async function loadGlobalFont() {
        const savedFont = (await idb.get('configs', 'globalFont'))?.value;
        if (savedFont) {
            fontSelector.value = savedFont;
            document.getElementById('mobileScreen').style.fontFamily = savedFont;
        }
    }
    
    document.getElementById('mainWidgetBgInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = async (re) => {
                const imageData = re.target.result;
                document.getElementById('widget-bg-image').src = imageData;
                await idb.put('configs', { key: 'widgetBgImage', value: imageData });
                showToast('插件背景已更新');
            };
            reader.readAsDataURL(file);
        }
    });
    
    document.getElementById('fontColorWhite').addEventListener('click', async () => {
        desktopContainer.classList.add('font-white');
        desktopContainer.classList.remove('font-black');
        await idb.put('configs', { key: 'fontColor', value: 'white' });
    });
     document.getElementById('fontColorBlack').addEventListener('click', async () => {
        desktopContainer.classList.remove('font-white');
        desktopContainer.classList.add('font-black');
        await idb.put('configs', { key: 'fontColor', value: 'black' });
    });
    async function loadFontColor() {
        const color = (await idb.get('configs', 'fontColor'))?.value || 'white';
        if (color === 'white') {
            desktopContainer.classList.add('font-white');
            desktopContainer.classList.remove('font-black');
        } else {
            desktopContainer.classList.remove('font-white');
            desktopContainer.classList.add('font-black');
        }
    }

    document.querySelectorAll('.change-icon-shape').forEach(button => {
        button.addEventListener('click', function() {
            const shapeClass = this.dataset.shape;
            document.querySelectorAll('.app-icon-container').forEach(icon => {
                icon.classList.remove('rounded-2xl', 'rounded-full');
                icon.classList.add(shapeClass);
            });
        });
    });

    document.getElementById('stickyNoteBgInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = async (re) => {
                const imageData = re.target.result;
                applyStickyNoteBg(imageData);
                await idb.put('configs', { key: 'stickyNoteBgImage', value: imageData });
                showToast('便利贴背景已更新');
            };
            reader.readAsDataURL(file);
        }
    });
    
    function applyStickyNoteBg(imageData) {
        const widget = document.getElementById('sticky-note-widget');
        const bgLayer = document.getElementById('sticky-note-bg-layer');
        if (imageData) {
            bgLayer.style.backgroundImage = `url('${imageData}')`;
            bgLayer.style.display = 'block';
            widget.classList.remove('bg-white');
        } else {
            bgLayer.style.display = 'none';
            widget.classList.add('bg-white');
        }
    }

    async function loadStickyNoteBg() {
        const savedBg = (await idb.get('configs', 'stickyNoteBgImage'))?.value;
        if (savedBg) applyStickyNoteBg(savedBg);
    }

    async function populateIconUploads() {
        const listContainer = document.getElementById('icon-upload-list');
        listContainer.innerHTML = '';
        const apps = document.querySelectorAll('.app-item, footer .app-icon-container');
        apps.forEach((app) => {
            const appId = app.dataset.appId;
            const appLabel = app.dataset.appName || app.querySelector('.editable-text')?.textContent;
            const iconContainer = app.classList.contains('app-item') ? app.querySelector('.app-icon-container') : app;
            const iconContainerId = iconContainer.id;
            
            if (!appId || !appLabel) return;

            const item = document.createElement('div');
            item.className = 'icon-upload-item';
            item.innerHTML = `
                <span class="font-medium">${appLabel}</span>
                <input type="file" id="icon-file-${appId}" class="hidden" accept="image/*" data-target-icon="${iconContainerId}">
                <label for="icon-file-${appId}" class="icon-upload-label">上传</label>
            `;
            listContainer.appendChild(item);

            const fileInput = document.getElementById(`icon-file-${appId}`);
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                const targetIconId = e.target.dataset.targetIcon;
                if (file && targetIconId) {
                    const reader = new FileReader();
                    reader.onload = async (re) => {
                        const iconDataUrl = re.target.result;
                        const iconElement = document.getElementById(targetIconId);
                        iconElement.innerHTML = '';
                        iconElement.style.backgroundImage = `url('${iconDataUrl}')`;
                        
                        const customIcons = (await idb.get('configs', 'customIcons'))?.value || {};
                        customIcons[targetIconId] = iconDataUrl;
                        await idb.put('configs', { key: 'customIcons', value: customIcons });

                        showToast(`“${appLabel}”图标已更新`);
                    };
                    reader.readAsDataURL(file);
                }
            });
        });
    }

    async function loadCustomIcons() {
        const customIcons = (await idb.get('configs', 'customIcons'))?.value || {};
        for (const iconId in customIcons) {
            const iconElement = document.getElementById(iconId);
            if (iconElement && customIcons[iconId]) {
                iconElement.innerHTML = '';
                iconElement.style.backgroundImage = `url('${customIcons[iconId]}')`;
            }
        }
    }
    
    // --- API 页面逻辑 ---
    document.getElementById('connectApiButton').addEventListener('click', async () => {
        const currentApiKey = document.getElementById('apiKeyInput').value.trim();
        const currentApiUrl = document.getElementById('apiUrlInput').value.trim();

        if (!currentApiKey || !currentApiUrl) {
            showToast('API地址和密钥不能为空');
            return;
        }
        
        await idb.put('configs', { key: 'apiKey', value: currentApiKey }); 
        await idb.put('configs', { key: 'apiUrl', value: currentApiUrl }); 

        showToast('正在连接并拉取模型...');
        
        try {
            const baseUrl = currentApiUrl.replace(/\/$/, ''); 
            const modelsUrl = `${baseUrl}/models`;

            const response = await fetch(modelsUrl, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${currentApiKey}`, 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                const errorMsg = errorData.error?.message || `HTTP错误: ${response.status}`;
                throw new Error(errorMsg);
            }

            const data = await response.json();
            
            let modelList = [];
            if (data.data && Array.isArray(data.data)) modelList = data.data; 
            else if (Array.isArray(data)) modelList = data; 
            else if (data.models && Array.isArray(data.models)) modelList = data.models; 
            else { console.warn("无法识别的API响应结构, 尝试将响应体作为数组..."); modelList = [data].flat(); }

            if (!Array.isArray(modelList)) throw new Error('返回数据格式不正确，无法解析为模型数组');
            
            const models = modelList.map(model => model.id || model.name || model.model).filter(Boolean); 

            if (models.length === 0) { console.error("API 响应数据:", JSON.stringify(data, null, 2)); throw new Error('解析了API响应，但未找到任何有效的模型名称'); }

            const modelSelector = document.getElementById('model-selector');
            const selectionContainer = document.getElementById('model-selection-container');
            
            modelSelector.innerHTML = '';
            models.forEach(modelName => {
                const option = new Option(modelName, modelName);
                modelSelector.appendChild(option);
            });
            
            await idb.put('configs', { key: 'apiModelsList', value: models });
            selectionContainer.classList.remove('hidden');
            showToast('模型列表拉取成功!');

        } catch (error) {
            console.error('拉取模型失败:', error);
            showToast(`拉取失败: ${error.message}`);
            document.getElementById('model-selection-container').classList.remove('hidden');
            document.getElementById('model-selector').innerHTML = `<option>拉取失败: ${error.message}</option>`;
        }
    });

    document.getElementById('save-api-model').addEventListener('click', async () => {
        const selectedModel = document.getElementById('model-selector').value;
        if (selectedModel) {
            await idb.put('configs', { key: 'globalApiModel', value: selectedModel });
            showToast(`已保存模型: ${selectedModel}`);
        }
    });

    async function loadApiModelSettings() {
        document.getElementById('apiKeyInput').value = (await idb.get('configs', 'apiKey'))?.value || '';
        document.getElementById('apiUrlInput').value = (await idb.get('configs', 'apiUrl'))?.value || '';
        const models = (await idb.get('configs', 'apiModelsList'))?.value;

        if (models && Array.isArray(models)) {
            const modelSelector = document.getElementById('model-selector');
            const selectionContainer = document.getElementById('model-selection-container');
            
            modelSelector.innerHTML = '';
            models.forEach(modelName => {
                const option = new Option(modelName, modelName);
                modelSelector.appendChild(option);
            });
            
            modelSelector.value = (await idb.get('configs', 'globalApiModel'))?.value || '';
            selectionContainer.classList.remove('hidden');
        }
    }

    // --- 桌面大插件自定义图片 ---
    const widgetBgImage = document.getElementById('widget-bg-image');
    const widgetProfileImage = document.getElementById('widget-profile-image');
    const widgetBgInput = document.getElementById('widget-bg-input');
    const widgetProfileInput = document.getElementById('widget-profile-input');

    widgetBgImage.addEventListener('click', () => widgetBgInput.click());
    widgetProfileImage.addEventListener('click', () => widgetProfileInput.click());

    widgetBgInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = async (re) => {
                const imageData = re.target.result;
                widgetBgImage.src = imageData;
                await idb.put('configs', { key: 'widgetBgImage', value: imageData });
            };
            reader.readAsDataURL(file);
        }
    });

    widgetProfileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = async (re) => {
                const imageData = re.target.result;
                widgetProfileImage.src = imageData;
                await idb.put('configs', { key: 'widgetProfileImage', value: imageData });
            };
            reader.readAsDataURL(file);
        }
    });

    async function loadWidgetImages() {
        const savedBg = (await idb.get('configs', 'widgetBgImage'))?.value;
        const savedProfile = (await idb.get('configs', 'widgetProfileImage'))?.value;
        if (savedBg) widgetBgImage.src = savedBg;
        if (savedProfile) widgetProfileImage.src = savedProfile;
    }

    // --- 世界书功能 ---
    function initializeWorldBookFeatures() {
        const worldbookEditorPage = document.getElementById('worldbook-editor-page');
        document.getElementById('createNewWorldBook').addEventListener('click', () => {
            document.getElementById('worldbook-id').value = '';
            document.getElementById('worldbook-title').value = '';
            document.getElementById('worldbook-content').value = '';
            showPage(worldbookEditorPage);
        });
        document.getElementById('saveWorldBook').addEventListener('click', async () => {
            const id = document.getElementById('worldbook-id').value;
            const title = document.getElementById('worldbook-title').value.trim();
            if (!title) { showToast('标题不能为空'); return; }

            const bookData = {
                id: id ? parseInt(id) : Date.now(),
                title: title,
                content: document.getElementById('worldbook-content').value.trim()
            };
            await idb.put('worldBooks', bookData);
            
            showToast('保存成功');
            goBack();
        });
    }

    async function renderWorldBookList() {
        const books = await idb.getAll('worldBooks') || [];
        const container = document.getElementById('worldbook-list-container');
        container.innerHTML = '';
        if(!Array.isArray(books) || books.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 mt-8">还没有世界书...</p>'; return;
        }
        books.forEach(book => {
            const item = document.createElement('div');
            item.className = 'list-item rounded-lg';
            item.innerHTML = `<span>${book.title}</span><span class="text-gray-400">&gt;</span>`;
            item.addEventListener('click', async () => {
                const bookData = await idb.get('worldBooks', book.id);
                if(bookData){
                    document.getElementById('worldbook-id').value = bookData.id;
                    document.getElementById('worldbook-title').value = bookData.title;
                    document.getElementById('worldbook-content').value = bookData.content;
                    showPage(document.getElementById('worldbook-editor-page'));
                }
            });
            container.appendChild(item);
        });
    }
    
    // --- 微信功能 ---
    const wechatPage = document.getElementById('wechat-page');
    const wechatTabs = wechatPage.querySelectorAll('.wechat-tab');
    const wechatTabContents = wechatPage.querySelectorAll('.wechat-tab-content');

    wechatTabs.forEach(tab => {
        tab.addEventListener('click', async () => {
            wechatTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            const targetContentId = tab.dataset.tab;
            wechatTabContents.forEach(content => {
                content.id === targetContentId ? content.classList.remove('hidden') : content.classList.add('hidden');
            });
             if (targetContentId === 'wechat-me-tab-content') {
                await renderMyPersonas();
            }
        });
    });

    // --- “我”页面与多人设功能 ---
    const meSettingsPage = document.getElementById('me-settings-page');
    let newMeAvatarData = null;

    async function renderMyPersonas() {
        const personas = await idb.getAll('userPersonas') || [];
        const listContainer = document.getElementById('my-personas-list');
        listContainer.innerHTML = '';

        if (!personas || personas.length === 0) {
            listContainer.innerHTML = `<div class="text-center p-8 text-gray-500">你还没有创建人设，点击下方按钮开始吧。</div>`;
        } else {
            personas.forEach(persona => {
                const personaCard = document.createElement('div');
                personaCard.className = 'bg-white p-3 rounded-xl flex items-center space-x-3 cursor-pointer';
                personaCard.innerHTML = `
                    <img src="${persona.avatar || 'https://placehold.co/80x80/e2e8f0/94a3b8?text=Me'}" alt="Persona Avatar" class="w-16 h-16 rounded-lg object-cover flex-shrink-0">
                    <div class="flex-grow min-w-0">
                        <h3 class="font-semibold text-lg truncate">${persona.name}</h3>
                        <p class="text-xs text-gray-500 line-clamp-2">${persona.persona || '暂无设定'}</p>
                    </div>
                    <span class="text-gray-400 flex-shrink-0">&gt;</span>
                `;
                personaCard.addEventListener('click', () => openPersonaEditor(persona.id));
                listContainer.appendChild(personaCard);
            });
        }
    }

    document.getElementById('add-new-persona-btn').addEventListener('click', () => openPersonaEditor());

    async function openPersonaEditor(personaId = null) {
        const personaIdInput = document.getElementById('me-settings-persona-id');
        const nameInput = document.getElementById('me-settings-name');
        const personaInput = document.getElementById('me-settings-persona');
        const avatarPreview = document.getElementById('me-settings-avatar-preview');
        
        if (personaId) {
            const persona = await idb.get('userPersonas', personaId);
            if (persona) {
                personaIdInput.value = persona.id;
                nameInput.value = persona.name || '';
                personaInput.value = persona.persona || '';
                avatarPreview.src = persona.avatar || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=Avatar';
                newMeAvatarData = persona.avatar;
            }
        } else {
            personaIdInput.value = '';
            nameInput.value = '';
            personaInput.value = '';
            avatarPreview.src = 'https://placehold.co/100x100/e2e8f0/94a3b8?text=Avatar';
            newMeAvatarData = null;
        }
        showPage(meSettingsPage);
    }
    
    document.getElementById('me-settings-avatar-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (re) => {
                newMeAvatarData = re.target.result;
                document.getElementById('me-settings-avatar-preview').src = newMeAvatarData;
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('save-me-settings-btn').addEventListener('click', async () => {
        const name = document.getElementById('me-settings-name').value.trim();
        if (!name) { showToast('名字不能为空'); return; }
        
        const personaId = document.getElementById('me-settings-persona-id').value;
        const newPersonaData = {
            id: personaId || `persona_${Date.now()}`,
            name: name,
            persona: document.getElementById('me-settings-persona').value.trim(),
            avatar: newMeAvatarData
        };

        await idb.put('userPersonas', newPersonaData);
        showToast('人设已保存');
        goBack();
    });
    
    // --- 聊天列表功能 ---
    const addFriendModal = document.getElementById('add-friend-modal');
    let newFriendAvatarData = null;

    document.getElementById('wechat-add-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('wechat-add-menu').classList.toggle('hidden');
    });
    document.body.addEventListener('click', () => document.getElementById('wechat-add-menu').classList.add('hidden'));

    document.getElementById('wechat-add-friend').addEventListener('click', async () => {
        const worldbookSelect = document.getElementById('add-friend-worldbook');
        const books = await idb.getAll('worldBooks') || [];
        worldbookSelect.innerHTML = '<option value="">不绑定世界书</option>';
        if(Array.isArray(books)) {
            books.forEach(book => worldbookSelect.add(new Option(book.title, book.id)));
        }
        
        document.getElementById('add-friend-name').value = '';
        document.getElementById('add-friend-persona').value = '';
        document.getElementById('add-friend-avatar-preview').src = 'https://placehold.co/100x100/e2e8f0/94a3b8?text=Avatar';
        newFriendAvatarData = null;
        
        addFriendModal.classList.remove('hidden');
        addFriendModal.classList.add('flex');
    });

    document.getElementById('add-friend-avatar').addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = re => {
                newFriendAvatarData = re.target.result;
                document.getElementById('add-friend-avatar-preview').src = newFriendAvatarData;
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('add-friend-confirm').addEventListener('click', async () => {
        const name = document.getElementById('add-friend-name').value.trim();
        if (!name) { showToast('好友名字不能为空'); return; }
        const newFriend = {
            id: 'char_' + Date.now(),
            name: name,
            persona: document.getElementById('add-friend-persona').value.trim(),
            avatar: newFriendAvatarData || `https://ui-avatars.com/api/?name=${encodeURIComponent(name[0])}&background=random`,
            worldBookId: document.getElementById('add-friend-worldbook').value,
            userPersonaId: '' // 新增好友时，默认不指定我的人设
        };
        await idb.put('chatCharacters', newFriend);
        
        addFriendModal.classList.add('hidden');
        addFriendModal.classList.remove('flex');
        await renderChatList();
        showToast(`已添加好友 ${name}`);

        const firstItem = document.querySelector('#wechat-chat-list .wechat-friend-item:first-child');
        if (firstItem) {
            firstItem.classList.add('new-friend-glow');
            setTimeout(() => firstItem.classList.remove('new-friend-glow'), 1500);
        }
    });
    document.getElementById('add-friend-cancel').addEventListener('click', () => {
        addFriendModal.classList.add('hidden');
        addFriendModal.classList.remove('flex');
    });

    async function renderChatList() {
        const friends = await idb.getAll('chatCharacters') || [];
        friends.sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0)); // 按最后消息时间排序

        const listContainer = document.getElementById('wechat-chat-list');
        listContainer.innerHTML = '';
        if (!Array.isArray(friends) || friends.length === 0) {
             listContainer.innerHTML = '<p class="text-center text-gray-500 mt-8">还没有好友，点击右上角 + 添加一个吧。</p>';
             return;
        }

        for (const friend of friends) {
             const messages = await idb.getMessagesForChat(friend.id);
             const lastMessage = messages[messages.length - 1];
             const lastMessageText = lastMessage ? (lastMessage.type === 'image' ? '[图片]' : (lastMessage.type === 'voice' ? '[语音]' : lastMessage.text)) : '...';
             const lastMessageTime = lastMessage ? new Date(lastMessage.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '11:14';

            const item = document.createElement('div');
            item.className = 'wechat-friend-item cursor-pointer';
            item.innerHTML = `
                <div class="flex items-center space-x-4">
                    <img src="${friend.avatar}" class="w-12 h-12 rounded-lg object-cover flex-shrink-0">
                    <div class="flex-grow min-w-0">
                        <span class="font-semibold text-base truncate">${friend.name}</span>
                        <p class="text-sm text-gray-500 truncate">${lastMessageText}</p>
                    </div>
                    <span class="text-xs text-gray-400 self-start">${lastMessageTime}</span>
                </div>
            `;
            item.addEventListener('click', () => openChat(friend.id));
            listContainer.appendChild(item);
        }
    }

    // --- 聊天界面功能 ---
    const chatInterfacePage = document.getElementById('chat-interface-page');
    const chatDetailsPage = document.getElementById('chat-details-page');
    const chatInput = document.getElementById('chat-input');
    const chatSendBtn = document.getElementById('chat-send-btn');
    const chatPlusBtn = document.getElementById('chat-plus-btn');
    const chatPlusMenu = document.getElementById('chat-plus-menu');
    let currentChattingCharacter = null;
    let isAiReplying = false;

    const BLACK_IMAGE_PLACEHOLDER = 'data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=';

    async function openChat(characterId) {
        const character = await idb.get('chatCharacters', characterId);
        if (!character) return;
        
        currentChattingCharacter = character;
        document.getElementById('chat-header-name').textContent = character.name;
        await renderChatHistory(characterId);
        showPage(chatInterfacePage);
    }
    
    let longPressTimer;
    function addMessageEventListeners(wrapper, msg) {
        wrapper.addEventListener('contextmenu', e => e.preventDefault());
        wrapper.addEventListener('mousedown', e => {
            if (e.button !== 0 && e.pointerType !== 'touch') return;
            longPressTimer = setTimeout(() => {
                if (confirm(`确定要删除这条消息吗？`)) deleteMessage(msg.id);
            }, 800);
        });
        wrapper.addEventListener('mouseup', () => clearTimeout(longPressTimer));
        wrapper.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
        wrapper.addEventListener('touchstart', e => {
            longPressTimer = setTimeout(() => {
                e.preventDefault();
                if (confirm(`确定要删除这条消息吗？`)) deleteMessage(msg.id);
            }, 800);
        });
        wrapper.addEventListener('touchend', () => clearTimeout(longPressTimer));
        wrapper.addEventListener('touchmove', () => clearTimeout(longPressTimer));

        const bubble = wrapper.querySelector('.chat-bubble');
        if (msg.type === 'image' && msg.content === BLACK_IMAGE_PLACEHOLDER) {
            bubble.addEventListener('click', () => revealImage(bubble, msg));
        } else if (msg.type === 'image') {
            bubble.addEventListener('click', () => {
                const desc = bubble.querySelector('.image-description');
                if (desc) desc.style.display = desc.style.display === 'none' ? 'block' : 'none';
            });
        }
    }
    
    async function deleteMessage(messageId) {
        await idb.delete('chatMessages', messageId);
        await renderChatHistory(currentChattingCharacter.id);
        showToast('消息已删除');
    }

    async function revealImage(bubbleElement, msg) {
        const imgElement = bubbleElement.querySelector('img');
        const descElement = bubbleElement.querySelector('.image-description');
        
        imgElement.src = msg.originalContent;
        if (descElement) descElement.style.display = 'block';
        
        // Update the message in the database
        const dbMsg = await idb.get('chatMessages', msg.id);
        if (dbMsg) {
            dbMsg.content = dbMsg.originalContent;
            await idb.put('chatMessages', dbMsg);
        }
        
        // Re-bind event listener to the cloned node to avoid recursion
        const newBubbleElement = bubbleElement.cloneNode(true);
        bubbleElement.replaceWith(newBubbleElement);
        newBubbleElement.addEventListener('click', () => {
            const desc = newBubbleElement.querySelector('.image-description');
            if (desc) desc.style.display = desc.style.display === 'none' ? 'block' : 'none';
        });
    }

    async function renderChatHistory(characterId) {
        const messagesContainer = document.getElementById('chat-messages-container');
        messagesContainer.innerHTML = '';
        const history = await idb.getMessagesForChat(characterId) || [];
        
        const myPersonas = await idb.getAll('userPersonas') || [];
        const myPersona = myPersonas.find(p => p.id === currentChattingCharacter.userPersonaId) || myPersonas[0];
        const myAvatar = myPersona ? myPersona.avatar : 'https://placehold.co/80x80/e2e8f0/94a3b8?text=Me';
        const theirAvatar = currentChattingCharacter.avatar;

        history.forEach(msg => { 
            const isMe = msg.sender === 'me';
            const avatarSrc = isMe ? myAvatar : theirAvatar;

            const wrapper = document.createElement('div');
            wrapper.className = `chat-message-wrapper ${isMe ? 'sent' : 'received'}`;
            
            let bubbleContent = '';
            switch(msg.type) {
                case 'voice':
                    const duration = Math.max(1, Math.round(msg.text.length / 4));
                    const width = Math.min(220, 80 + msg.text.length * 5);
                     bubbleContent = `
                        <div class="voice-bubble" style="width: ${width}px; padding: 0 !important;">
                             <svg class="w-5 h-5 text-gray-700 voice-icon" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm13.5 9.5a.5.5 0 010-1H18a.5.5 0 010 1h-.5zM2 9.5a.5.5 0 010-1H1a.5.5 0 010 1h1zM11 .5a.5.5 0 011 0v1a.5.5 0 01-1 0v-1zM11 18.5a.5.5 0 011 0v1a.5.5 0 01-1 0v-1z"></path></svg>
                             <div class="voice-wave"><span class="w-1"></span><span class="w-2"></span><span class="w-3"></span></div>
                             <span class="voice-duration">${duration}"</span>
                        </div>
                        ${msg.text ? `<div class="voice-translation">${msg.text}</div>` : ''}
                    `;
                    break;
                case 'image':
                    const imgSrc = msg.content;
                    bubbleContent = `<img src="${imgSrc}" class="chat-image" alt="chat image">`;
                    if (msg.description) {
                        const displayStyle = imgSrc === BLACK_IMAGE_PLACEHOLDER ? 'none' : 'block';
                        bubbleContent += `<div class="image-description" style="display: ${displayStyle};">${msg.description}</div>`;
                    }
                    break;
                default:
                    bubbleContent = `<span style="white-space: pre-wrap;">${msg.text}</span>`;
            }

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${isMe ? 'chat-bubble-sent' : 'chat-bubble-received'}`;
            if(msg.type === 'image') {
                bubble.style.padding = '5px';
                bubble.style.backgroundColor = isMe ? '#a9e87a' : '#ffffff';
                if(msg.content === BLACK_IMAGE_PLACEHOLDER) bubble.style.backgroundColor = '#000000';
            } else if (msg.type === 'voice') {
                 bubble.style.padding = '8px 12px';
            }
            bubble.innerHTML = bubbleContent;
            
            const avatarImg = document.createElement('img');
            avatarImg.src = avatarSrc;
            avatarImg.className = 'chat-avatar';
            
            wrapper.appendChild(avatarImg);
            wrapper.appendChild(bubble);
            messagesContainer.appendChild(wrapper);

            addMessageEventListeners(wrapper, msg);
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }


    chatInput.addEventListener('input', function() {
        if (this.value.trim().length > 0) {
            chatSendBtn.classList.remove('hidden');
            chatPlusBtn.classList.add('hidden');
        } else {
            chatSendBtn.classList.add('hidden');
            chatPlusBtn.classList.remove('hidden');
        }
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    async function addMessageToHistory(characterId, messageData) {
        await idb.put('chatMessages', messageData);

        // Update last message time on the character for sorting chat list
        const char = await idb.get('chatCharacters', characterId);
        if(char) {
            char.lastMessageTime = messageData.time;
            await idb.put('chatCharacters', char);
        }

        await renderChatHistory(characterId);
    }
    
    async function addUserMessage(messageData) {
        if (!currentChattingCharacter) return;
        const fullMessage = { 
            characterId: currentChattingCharacter.id, 
            sender: 'me', 
            ...messageData, 
            time: Date.now() 
        };
        await addMessageToHistory(currentChattingCharacter.id, fullMessage);

        if (chatInput.value) {
            chatInput.value = '';
            chatInput.dispatchEvent(new Event('input'));
        }
    }

    chatSendBtn.addEventListener('click', () => {
        const text = chatInput.value.trim();
        if (text) addUserMessage({ type: 'text', text: text });
    });
    chatInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatSendBtn.click();
        }
    });

    document.getElementById('chat-ai-reply-btn').addEventListener('click', () => {
        if (isAiReplying) { showToast('AI 正在回复中...'); return; }
        triggerAiReply();
    });

    chatPlusBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (chatPlusMenu.classList.contains('hidden')) {
            chatPlusMenu.classList.remove('hidden');
            setTimeout(() => chatPlusMenu.classList.remove('opacity-0', '-translate-y-4'), 10);
        } else {
            chatPlusMenu.classList.add('opacity-0', '-translate-y-4');
            setTimeout(() => chatPlusMenu.classList.add('hidden'), 200);
        }
    });

    document.getElementById('chat-upload-image').addEventListener('click', () => document.getElementById('chat-image-input').click());
    document.getElementById('chat-image-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (re) => {
                document.getElementById('imageRawData').value = re.target.result;
                document.getElementById('imageDescInput').value = '';
                imageDescModal.classList.remove('hidden');
                imageDescModal.classList.add('flex');
                imageDescInput.focus();
                chatPlusBtn.click(); 
            };
            reader.readAsDataURL(file);
        }
        e.target.value = '';
    });
    
    const imageDescModal = document.getElementById('imageDescriptionModal');
    const imageDescInput = document.getElementById('imageDescInput');
    document.getElementById('chat-take-photo').addEventListener('click', () => {
        document.getElementById('imageRawData').value = '';
        imageDescInput.value = '';
        imageDescModal.classList.remove('hidden');
        imageDescModal.classList.add('flex');
        imageDescInput.focus();
        chatPlusBtn.click();
    });
    document.getElementById('cancelImageDesc').addEventListener('click', () => {
        imageDescModal.classList.add('hidden');
        imageDescModal.classList.remove('flex');
        document.getElementById('imageRawData').value = ''; 
    });
     document.getElementById('confirmImageDesc').addEventListener('click', () => {
        const text = imageDescInput.value.trim();
        const rawImageData = document.getElementById('imageRawData').value;

        if (rawImageData && text) addUserMessage({ type: 'image', content: BLACK_IMAGE_PLACEHOLDER, description: text, originalContent: rawImageData });
        else if (rawImageData) addUserMessage({ type: 'image', content: rawImageData, description: '' });
        else {
            const imageUrl = `https://placehold.co/400x300/eee/333?text=${encodeURIComponent(text.substring(0, 30))}`;
            addUserMessage({ type: 'image', content: imageUrl, description: text });
        }
        imageDescModal.classList.add('hidden');
        imageDescModal.classList.remove('flex');
        document.getElementById('imageRawData').value = '';
    });

    const modeToggleBtn = document.getElementById('chat-mode-toggle-btn');
    const voiceIcon = document.getElementById('chat-voice-icon');
    const keyboardIcon = document.getElementById('chat-keyboard-icon');
    const holdToTalkBtn = document.getElementById('chat-hold-to-talk-btn');

    modeToggleBtn.addEventListener('click', () => {
        const isTextMode = keyboardIcon.classList.contains('hidden');
        voiceIcon.classList.toggle('hidden', !isTextMode);
        keyboardIcon.classList.toggle('hidden', isTextMode);
        chatInput.classList.toggle('hidden', !isTextMode);
        holdToTalkBtn.classList.toggle('hidden', isTextMode);
        if (isTextMode) chatInput.focus();
    });
    
    const voiceInputModal = document.getElementById('voiceInputModal');
    holdToTalkBtn.addEventListener('click', () => {
        document.getElementById('voiceInputText').value = '';
        voiceInputModal.classList.remove('hidden');
        voiceInputModal.classList.add('flex');
    });
    document.getElementById('cancelVoiceInput').addEventListener('click', () => {
        voiceInputModal.classList.add('hidden');
        voiceInputModal.classList.remove('flex');
    });
    document.getElementById('confirmVoiceInput').addEventListener('click', () => {
        const text = document.getElementById('voiceInputText').value.trim();
        if (text) addUserMessage({ type: 'voice', text: text });
        voiceInputModal.classList.add('hidden');
        voiceInputModal.classList.remove('flex');
    });

    // --- AI 回复逻辑 ---
    async function triggerAiReply() {
        if (!currentChattingCharacter || isAiReplying) return;

        const apiKey = (await idb.get('configs', 'apiKey'))?.value || '';
        const apiUrl = (await idb.get('configs', 'apiUrl'))?.value || '';
        const model = (await idb.get('configs', 'globalApiModel'))?.value || '';

        if (!apiKey || !apiUrl || !model) {
            showToast('请先在设置中连接并保存API模型');
            return;
        }

        isAiReplying = true;
        const charId = currentChattingCharacter.id;
        const character = currentChattingCharacter;

        const messagesContainer = document.getElementById('chat-messages-container');
        const theirAvatar = currentChattingCharacter.avatar;
        const typingIndicator = document.createElement('div');
        typingIndicator.id = 'typing-indicator';
        typingIndicator.className = 'chat-message-wrapper received';
        typingIndicator.innerHTML = `
            <img src="${theirAvatar}" class="chat-avatar">
            <div class="chat-bubble chat-bubble-received">
                <span class="italic text-gray-500">对方正在输入中...</span>
            </div>
        `;
        messagesContainer.appendChild(typingIndicator);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        const worldbook = character.worldBookId ? await idb.get('worldBooks', parseInt(character.worldBookId)) : null;
        const userPersona = character.userPersonaId ? await idb.get('userPersonas', character.userPersonaId) : null;

        let systemPrompt = `你正在扮演一个角色进行对话。请严格按照以下设定进行回复，回复时不要暴露你是AI或模型的身份，要完全沉浸在角色中。\n\n核心要求：回复**必须**简短、口语化，像真人聊天一样。回复的长度和条数应该自然变化。\n\n分割技巧：为了更真实地模拟真人连续发送短消息的效果，如果你的回复内容较长或包含多个意群，请使用特殊分隔符 "|||" 将回复分割成**多条不固定数量**的短消息。例如：一个长句可以拆成："我今天过得很开心|||你呢？在忙什么|||有没有想我呀？" \n请根据内容的连贯性和聊天节奏来决定是否分割、以及分割成几条，不要生硬地分割。\n---\n[你的角色设定]\n${character.persona || '无'}\n---\n[对话者的设定 (我)]\n${userPersona ? userPersona.persona : '无'}\n---`;

        if (worldbook && worldbook.content) {
            systemPrompt += `\n[相关的世界背景设定]\n${worldbook.content}\n---`;
        }

        const recentHistory = (await idb.getMessagesForChat(charId)).slice(-10);
        const messages = [
            { role: 'system', content: systemPrompt },
            ...recentHistory.map(msg => ({
                role: msg.sender === 'me' ? 'user' : 'assistant',
                content: msg.type === 'image' ? `[用户发送了图片，描述为: ${msg.description || '无'}]` : msg.text
            }))
        ];

        const baseUrl = apiUrl.replace(/\/$/, '');
        const chatUrl = `${baseUrl}/chat/completions`;

        try {
            const response = await fetch(chatUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({ model: model, messages: messages, stream: false })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error.message);
            }

            const data = await response.json();
            const fullReply = data.choices[0].message.content;

            if (fullReply) {
                const messagesToSend = fullReply.split('|||').map(s => s.trim()).filter(s => s.length > 0);
                for (const messagePart of messagesToSend) {
                    const delay = Math.random() * 1200 + 800;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    const aiMessage = { characterId: charId, sender: 'them', type: 'text', text: messagePart, time: Date.now() };
                    await addMessageToHistory(charId, aiMessage);
                }
            }

        } catch (error) {
            console.error('AI回复错误:', error);
            showToast(`AI回复出错: ${error.message}`);
            await addMessageToHistory(charId, { characterId: charId, sender: 'them', type: 'text', text: `(AI回复出错了: ${error.message})`, time: Date.now() });
        } finally {
            document.getElementById('typing-indicator')?.remove();
            isAiReplying = false;
        }
    }


    // --- 聊天设置与详情页逻辑 ---
    document.getElementById('go-to-chat-details-btn').addEventListener('click', (e) => {
        e.preventDefault();
        if (currentChattingCharacter) {
            setupChatDetailsPage(currentChattingCharacter);
            showPage(chatDetailsPage);
        }
    });

    const customBubbleModal = document.getElementById('customBubbleModal');
    document.getElementById('open-bubble-css-editor').addEventListener('click', async (e) => {
        document.getElementById('bubbleCssInput').value = (await idb.get('configs', 'customBubbleCss'))?.value || '';
        customBubbleModal.classList.remove('hidden');
        customBubbleModal.classList.add('flex');
    });
    document.getElementById('saveBubbleCss').addEventListener('click', async () => {
        const css = document.getElementById('bubbleCssInput').value;
        document.getElementById('custom-bubble-style').innerHTML = css;
        await idb.put('configs', { key: 'customBubbleCss', value: css });
        customBubbleModal.classList.add('hidden');
        customBubbleModal.classList.remove('flex');
        showToast('气泡样式已保存');
    });
    document.getElementById('cancelBubbleCss').addEventListener('click', () => {
        customBubbleModal.classList.add('hidden');
        customBubbleModal.classList.remove('flex');
    });
     document.getElementById('copyBubbleCss').addEventListener('click', () => {
        const template = `.chat-bubble-sent {\n  /* 我发送的气泡 */\n  background: linear-gradient(to right, #89f7fe, #66a6ff);\n  color: white;\n}\n\n.chat-bubble-received {\n  /* 对方发送的气泡 */\n  background-color: #f1f1f1;\n  color: #333;\n}`;
        navigator.clipboard.writeText(template).then(() => showToast('CSS模板已复制'));
    });

    async function setupChatDetailsPage(character) {
        document.getElementById('details-character-name').textContent = character.name;
        document.getElementById('details-character-persona').textContent = character.persona || '暂无设定';
        document.getElementById('details-character-avatar').src = character.avatar;
        document.getElementById('details-avatar-label-name').textContent = character.name;
        
        const worldbookSelector = document.getElementById('details-worldbook-selector');
        const books = await idb.getAll('worldBooks') || [];
        worldbookSelector.innerHTML = '<option value="">不绑定世界书</option>';
        if (Array.isArray(books)) books.forEach(book => worldbookSelector.add(new Option(book.title, book.id)));
        worldbookSelector.value = character.worldBookId || '';
        worldbookSelector.onchange = async function() {
            const friend = await idb.get('chatCharacters', character.id);
            if(friend) {
                friend.worldBookId = this.value;
                await idb.put('chatCharacters', friend);
                currentChattingCharacter.worldBookId = this.value;
                showToast('世界书已切换');
            }
        };

        const myPersonas = await idb.getAll('userPersonas') || [];
        const personaSelector = document.getElementById('details-persona-selector');
        personaSelector.innerHTML = '';
        if (myPersonas.length > 0) myPersonas.forEach(p => personaSelector.add(new Option(p.name, p.id)));
        else personaSelector.add(new Option('未设置人设', ''));
        
        personaSelector.value = character.userPersonaId || '';
        personaSelector.onchange = async function() {
            const friend = await idb.get('chatCharacters', character.id);
            if(friend) {
                friend.userPersonaId = this.value;
                await idb.put('chatCharacters', friend);
                currentChattingCharacter.userPersonaId = this.value;
                showToast('已切换当前聊天人设');
            }
        };

        const avatarBlock = document.getElementById('details-avatar-block');
        const avatarInput = document.getElementById('details-character-avatar-input');
        avatarBlock.onclick = () => avatarInput.click();
        avatarInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (re) => {
                    const newAvatar = re.target.result;
                    document.getElementById('details-character-avatar').src = newAvatar;
                    const friend = await idb.get('chatCharacters', character.id);
                    if (friend) {
                        friend.avatar = newAvatar;
                        await idb.put('chatCharacters', friend);
                        currentChattingCharacter.avatar = newAvatar;
                        showToast('头像已更新');
                    }
                };
                reader.readAsDataURL(file);
            }
            e.target.value = '';
        };

        const textBlock = document.getElementById('details-character-text-block');
        textBlock.onclick = () => {
            document.getElementById('personaEditName').value = character.name;
            document.getElementById('personaEditInput').value = character.persona;
            document.getElementById('personaEditModal').classList.remove('hidden');
            document.getElementById('personaEditModal').classList.add('flex');
        };
    }
    
    document.getElementById('clear-chat-history-btn').addEventListener('click', async () => {
        if (!currentChattingCharacter) return;
        if (confirm(`确定要清空与“${currentChattingCharacter.name}”的所有聊天记录吗？\n此操作不可恢复。`)) {
            await idb.deleteMessagesForChat(currentChattingCharacter.id);
            await renderChatHistory(currentChattingCharacter.id);
            showToast('聊天记录已清空');
        }
    });

    document.getElementById('cancelPersonaEdit').addEventListener('click', () => {
        document.getElementById('personaEditModal').classList.add('hidden');
        document.getElementById('personaEditModal').classList.remove('flex');
    });

    document.getElementById('confirmPersonaEdit').addEventListener('click', async () => {
        const newName = document.getElementById('personaEditName').value.trim();
        const newPersona = document.getElementById('personaEditInput').value.trim();
        if (!newName) { showToast('名字不能为空'); return; }

        const friend = await idb.get('chatCharacters', currentChattingCharacter.id);
        if (friend) {
            friend.name = newName;
            friend.persona = newPersona;
            await idb.put('chatCharacters', friend);

            currentChattingCharacter.name = newName;
            currentChattingCharacter.persona = newPersona;
            
            document.getElementById('details-character-name').textContent = newName;
            document.getElementById('details-character-persona').textContent = newPersona;
            document.getElementById('details-avatar-label-name').textContent = newName;
            document.getElementById('chat-header-name').textContent = newName;

            showToast('角色信息已更新');
            document.getElementById('personaEditModal').classList.add('hidden');
            document.getElementById('personaEditModal').classList.remove('flex');
        }
    });
    
    async function loadEditableText() {
        const allTexts = (await idb.get('configs', 'editableTexts'))?.value || {};
        for (const id in allTexts) {
            const element = document.getElementById(id);
            if (element) element.textContent = allTexts[id];
        }
    }
    
    // --- Initial Load (页面初始化加载) ---
    async function initialize() {
        initializeWorldBookFeatures();
        await Promise.all([
            loadCustomIcons(), 
            loadWidgetImages(), 
            loadStickyNoteBg(), 
            loadFontColor(), 
            loadEditableText(), 
            loadDesktopWallpaper(),
            loadCustomFonts(),
            loadGlobalFont(),
            loadApiModelSettings()
        ]);
        document.getElementById('custom-bubble-style').innerHTML = (await idb.get('configs', 'customBubbleCss'))?.value || ''; 
    }

    await initialize();
});

</script>

</body>
</html>